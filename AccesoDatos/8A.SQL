CLEAR SCR;
DROP TABLE EJEMPLO_TABLA_ANIDADA;
DROP TYPE TABLA_ANIDADA;
CREATE OR REPLACE TYPE TABLA_ANIDADA AS TABLE OF DIRECCION1;
/

CREATE TABLE EJEMPLO_TABLA_ANIDADA (
ID NUMBER(2),
APELLIDO VARCHAR2(35),
DIREC TABLA_ANIDADA) NESTED TABLE DIREC STORE AS DIREC_ANIDADA;

INSERT INTO EJEMPLO_TABLA_ANIDADA VALUES (1,'RAMOS',TABLA_ANIDADA(
					DIRECCION1('SANTO DOMINGO','MADRID',28028),
					DIRECCION1('INVENTADA','BARCELONA',28888),
					DIRECCION1('LAQUETUQUIERAS','MURCIA',25588),
					DIRECCION1('TREMENDA','ALICANTE',28228)
					));

INSERT INTO EJEMPLO_TABLA_ANIDADA VALUES (2,'ALBERTO',TABLA_ANIDADA(
					DIRECCION1('AYAYAY','CEUTA',28026),
					DIRECCION1('DELOCOS','MELILLA',28888)
					));

--FILTRAR SELECTS DE TABLAS ANIDADAS
SELECT E.DIREC FROM EJEMPLO_TABLA_ANIDADA E WHERE E.ID=1;
SELECT OPE.CALLE FROM EJEMPLO_TABLA_ANIDADA E, TABLE(E.DIREC) OPE WHERE E.ID=1;
--UPDATE EN TABLAS ANIDADAS
UPDATE TABLE(SELECT DIREC FROM EJEMPLO_TABLA_ANIDADA WHERE ID=1) ALIAS SET VALUE(ALIAS) = DIRECCION1('CALLE PINZON 13','TOLEDO',45555) WHERE VALUE(ALIAS)=DIRECCION1('TREMENDA','ALICANTE',28228);

SELECT OPE.CALLE FROM EJEMPLO_TABLA_ANIDADA E, TABLE(E.DIREC) OPE WHERE E.ID=1;
--INSERTAR EN TABLAS ANIDADAS
INSERT INTO TABLE(SELECT E.DIREC FROM EJEMPLO_TABLA_ANIDADA E WHERE ID=1) VALUES (DIRECCION1('CALLE INSERTADA','MADRID',20020));
SELECT OPE.CALLE FROM EJEMPLO_TABLA_ANIDADA E, TABLE(E.DIREC) OPE WHERE E.ID=1;
--UPDATE EN VARIAS CIUDADES
UPDATE EJEMPLO_TABLA_ANIDADA SET DIREC=TABLA_ANIDADA(
					DIRECCION1('CALLE UPDATE1','MADRID',28223),
					DIRECCION1('CALLE UPDATE2','MOSTOLES',28223),
					DIRECCION1('CALLE UPDATE3','MURCIA',28223)
) WHERE ID=1;
SELECT OPE.CALLE FROM EJEMPLO_TABLA_ANIDADA E, TABLE(E.DIREC) OPE WHERE E.ID=1;
--BORRADO TUPLA
DELETE FROM TABLE(SELECT E.DIREC FROM EJEMPLO_TABLA_ANIDADA E WHERE ID=1) ALIAS WHERE VALUE(ALIAS) = DIRECCION1('CALLE UPDATE1','MADRID',28223);
SELECT OPE.CALLE FROM EJEMPLO_TABLA_ANIDADA E, TABLE(E.DIREC) OPE WHERE E.ID=1;

--SELECTS FILTRADOS
SELECT CALLE,CIUDAD FROM THE(SELECT E.DIREC FROM EJEMPLO_TABLA_ANIDADA E WHERE ID=1) WHERE CIUDAD = 'MOSTOLES';
SELECT DIR.CALLE FROM EJEMPLO_TABLA_ANIDADA E, TABLE(E.DIREC) DIR WHERE E.ID=1 AND DIR.CIUDAD='MOSTOLES';

--PROCEDIMIENTO
CREATE OR REPLACE PROCEDURE VER_DIREC(IDENT NUMBER)
AS
	CURSOR C1 IS SELECT CALLE FROM THE(SELECT E.DIREC FROM EJEMPLO_TABLA_ANIDADA E WHERE ID=IDENT);
BEGIN
	FOR I IN C1 LOOP
		DBMS_OUTPUT.PUT_LINE(I.CALLE);
	END LOOP;
END;
/

DECLARE
BEGIN
	DBMS_OUTPUT.PUT_LINE('BLoque PL para usar el procedimiento');
	DBMS_OUTPUT.PUT_LINE('---------------------------------------');
	VER_DIREC(1);
END;
/
